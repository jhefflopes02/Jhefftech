<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>JT GPS</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#000000">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="icon.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20,400,0,0" />
    <style>
        body { background-color: #000000; color: white; font-family: -apple-system, sans-serif; -webkit-tap-highlight-color: transparent; min-height: 100dvh; display: flex; flex-direction: column; }
        .input-dark { background-color: #1c1c1e; border: 1px solid #2c2c2e; border-radius: 12px; color: white; padding: 14px; font-size: 16px; }
        button:disabled { opacity: 0.2; cursor: not-allowed; }
        .btn-active:active:not(:disabled) { transform: scale(0.96); opacity: 0.8; }
        .main-container { flex-grow: 1; display: flex; flex-direction: column; justify-content: center; width: 100%; max-width: 400px; margin: 0 auto; padding: 20px; }
    </style>
</head>
<body>
    <div class="main-container">
        <div class="flex flex-col items-center mb-8">
            <span class="material-symbols-outlined text-blue-500" style="font-size: 60px;">location_on</span>
            <h1 class="text-4xl font-bold tracking-tight mt-2">JT GPS</h1>
            <p class="text-zinc-500 text-sm uppercase tracking-widest">Localizações</p>
        </div>
        <div class="space-y-5 w-full">
            <div class="flex flex-col gap-2">
                <label class="text-zinc-400 text-xs font-bold ml-1 uppercase">Cliente:</label>
                <input type="text" id="clientName" placeholder="Nome do cliente" class="input-dark w-full outline-none focus:border-zinc-500" oninput="validateForm()">
            </div>
            <div class="flex flex-col gap-2">
                <label class="text-zinc-400 text-xs font-bold ml-1 uppercase">Observações:</label>
                <textarea id="observations" rows="2" placeholder="Digite a observação" class="input-dark w-full outline-none focus:border-zinc-500 resize-none" oninput="validateForm()"></textarea>
            </div>
            <div id="photoPreview" class="hidden flex flex-col items-center gap-2 bg-[#1c1c1e] p-3 rounded-xl border border-zinc-800">
                <div class="relative w-24 h-28">
                    <img id="previewImg" class="w-full h-full object-cover rounded-lg border border-zinc-700">
                    <button onclick="clearStoredPhoto()" class="absolute -top-2 -right-2 bg-red-600 rounded-full w-7 h-7 flex items-center justify-center shadow-lg">
                        <span class="material-symbols-outlined text-white text-[16px]">close</span>
                    </button>
                </div>
                <div id="gpsLoadingAnim" class="flex items-center gap-2">
                    <div class="w-2 h-2 bg-blue-500 rounded-full animate-pulse"></div>
                    <span class="text-[10px] text-blue-400 font-bold uppercase tracking-widest">Aguardando sinal estável...</span>
                </div>
            </div>
            <div class="flex flex-col gap-4 pt-2">
                <button id="btnObter" onclick="startProcess(false)" disabled class="btn-active w-full h-16 bg-[#007aff] text-white rounded-2xl font-bold text-xl shadow-lg">COLETAR</button>
                <button id="btnFoto" onclick="handlePhotoButton()" disabled class="btn-active w-full h-16 bg-[#34c759] text-white rounded-2xl font-bold text-xl shadow-lg">COLETAR COM FOTO</button>
            </div>
        </div>
        <div class="mt-8 text-center space-y-4">
            <div id="statusLabel" class="text-blue-500 font-bold text-xs h-4 uppercase tracking-widest"></div>
            <div class="pt-2">
                <p class="text-[10px] text-zinc-600 uppercase">Desenvolvido por:</p>
                <p class="text-xs text-zinc-400 font-bold uppercase tracking-widest">Jheff Lopes</p>
            </div>
        </div>
    </div>
    <div class="p-6 flex justify-center">
        <button onclick="handleExit()" class="btn-active bg-[#ff3b30] text-white px-14 h-11 rounded-full font-bold text-xs uppercase tracking-widest">Sair</button>
    </div>
    <input type="file" id="cameraInput" accept="image/*" capture="environment" class="hidden">
    <script>
        const clientInput = document.getElementById('clientName');
        const obsInput = document.getElementById('observations');
        const cameraInput = document.getElementById('cameraInput');
        const statusLabel = document.getElementById('statusLabel');
        const photoPreview = document.getElementById('photoPreview');
        const previewImg = document.getElementById('previewImg');
        const btnFoto = document.getElementById('btnFoto');
        let isProcessing = false;
        let photoBuffer = null;
        function validateForm() {
            const val = clientInput.value.trim();
            const hasText = val.length > 0;
            document.getElementById('btnObter').disabled = !hasText || isProcessing;
            btnFoto.disabled = val === "0" || !hasText || isProcessing;
            if (photoBuffer) {
                btnFoto.innerText = "REENVIAR COM ESTA FOTO";
                btnFoto.classList.replace('bg-[#34c759]', 'bg-[#ff9500]');
            } else {
                btnFoto.innerText = "COLETAR COM FOTO";
                btnFoto.classList.replace('bg-[#ff9500]', 'bg-[#34c759]');
            }
        }
        function handlePhotoButton() {
            if (photoBuffer) startProcess(true, photoBuffer);
            else cameraInput.click();
        }
        function clearStoredPhoto() {
            if(previewImg.src) URL.revokeObjectURL(previewImg.src);
            photoBuffer = null;
            cameraInput.value = "";
            photoPreview.classList.add('hidden');
            statusLabel.innerText = "";
            validateForm();
        }
        function clearAndResetAll() {
            clearStoredPhoto();
            clientInput.value = "";
            obsInput.value = "";
            localStorage.clear();
            sessionStorage.clear();
            validateForm();
            statusLabel.innerText = "";
        }
        function handleExit() {
            clearAndResetAll();
            window.close();
            setTimeout(() => { window.location.href = "about:blank"; }, 100);
        }
        cameraInput.onchange = (e) => {
            const file = e.target.files[0];
            if (file) {
                photoBuffer = file;
                previewImg.src = URL.createObjectURL(file);
                photoPreview.classList.remove('hidden');
                validateForm();
                startProcess(true, file);
            }
        };
        async function startProcess(withPhoto, file = null) {
            if (isProcessing) return;
            const name = clientInput.value.trim();
            const obs = obsInput.value.trim();
            try {
                isProcessing = true;
                validateForm();
                statusLabel.innerText = "Conectando ao GPS...";
                const pos = await new Promise((res, rej) => {
                    const startTime = Date.now();
                    const tryGetLocation = () => {
                        if (withPhoto && !photoBuffer) {
                            rej(new Error("Cancelado"));
                            return;
                        }
                        navigator.geolocation.getCurrentPosition(
                            (p) => res(p),
                            (err) => {
                                const elapsed = Date.now() - startTime;
                                if (elapsed < 20000) {
                                    setTimeout(tryGetLocation, 1000);
                                } else {
                                    rej(new Error("Timeout"));
                                }
                            },
                            { enableHighAccuracy: true, timeout: 5000, maximumAge: 0 }
                        );
                    };
                    tryGetLocation();
                });
                if (pos.coords.accuracy > 15) {
                    alert(`Precisão baixa (${Math.round(pos.coords.accuracy)}m). Tente local aberto.`);
                    isProcessing = false;
                    validateForm();
                    return;
                }
                const mapsUrl = `https://www.google.com/maps/search/?api=1&query=${pos.coords.latitude},${pos.coords.longitude}`;
                if (name === "0") {
                    await navigator.clipboard.writeText(mapsUrl);
                    clearAndResetAll();
                    isProcessing = false;
                    return;
                }
                let message = `CLIENTE: ${name.toUpperCase()}\n\n`;
                if (obs) message += `OBS:\n${obs.toUpperCase()}\n\n`;
                message += mapsUrl;
                if (withPhoto && navigator.share && file) {
                    const shareFile = new File([file], "gps_jt.jpg", { type: "image/jpeg" });
                    await navigator.share({ files: [shareFile], text: message });
                    clearAndResetAll();
                } else {
                    window.open(`https://wa.me/?text=${encodeURIComponent(message)}`, '_blank');
                    clearAndResetAll();
                }
                isProcessing = false;
            } catch (e) {
                if (e.message !== "Cancelado") {
                    alert("O GPS não respondeu a tempo. A foto ainda está salva, tente clicar em REENVIAR.");
                }
                isProcessing = false;
                validateForm();
            }
        }
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js');
            });
        }
    </script>
</body>
</html>
